
<html>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
   <link rel="stylesheet" href="css/mainscreen.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
   <body>
      <div class="w3-sidebar w3-bar-block w3-black w3-card w3-animate-left" style="display:none; width:20%;  height: 100%; border-radius: 5%; left: -1%;" id="leftMenu">
         <button onclick="closeLeftMenu()" class="w3-bar-item w3-button w3-large">Close &times;</button>
      </div>

      <div class="StatusLog" id="Status">
        <p> Not Ready </p>
      </div>

      <div class="w3-sidebar w3-bar-block w3-black w3-card w3-animate-right" style="display:none; width:100%;  height: 100%; border-radius: 100%; left:50%; top:0%;" id="rightMenu">
         <button onclick="closeRightMenu()" class="w3-bar-item w3-button w3-large">Close &times;</button>
         <div>
            <div class="TextLog">
               <h2 class="Sus" id="BUMPStatus"> Ready! </h2>
            </div>
            <div class="bumpAnimation">
               <svg id="SVG-Circus-38200f24-81e9-2af3-0580-ae49c43ce034" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                  <circle id="actor_3" cx="50" cy="50" r="31.5" opacity="1" fill="rgba(242,162,12,0)" fill-opacity="1" stroke="rgba(255,255,255,1)" stroke-width="1" stroke-opacity="1" stroke-dasharray=""></circle>
                  <script type="text/ecmascript"><![CDATA[(function(){var actors={};actors.actor_3={node:document.getElementById("SVG-Circus-38200f24-81e9-2af3-0580-ae49c43ce034").getElementById("actor_3"),type:"circle",cx:50,cy:50,dx:63,dy:10,opacity:1};var tricks={};tricks.trick_2=(function(t,i){i=(function(n){return.5>n?2*n*n:-1+(4-2*n)*n})(i)%1,i=0>i?1+i:i;var _=t.node;0.1>=i?_.setAttribute("opacity",i*(t.opacity/0.1)):i>=0.9?_.setAttribute("opacity",t.opacity-(i-0.9)*(t.opacity/(1-0.9))):_.setAttribute("opacity",t.opacity)});var scenarios={};scenarios.scenario_1={actors: ["actor_3"],tricks: [{trick: "trick_2",start:0,end:1}],startAfter:0,duration:6000,actorDelay:300,repeat:0,repeatDelay:1000};var _reqAnimFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,fnTick=function(t){var r,a,i,e,n,o,s,c,m,f,d,k,w;for(c in actors)actors[c]._tMatrix=[1,0,0,1,0,0];for(s in scenarios)for(o=scenarios[s],m=t-o.startAfter,r=0,a=o.actors.length;a>r;r++){if(i=actors[o.actors[r]],i&&i.node&&i._tMatrix)for(f=0,m>=0&&(d=o.duration+o.repeatDelay,o.repeat>0&&m>d*o.repeat&&(f=1),f+=m%d/o.duration),e=0,n=o.tricks.length;n>e;e++)k=o.tricks[e],w=(f-k.start)*(1/(k.end-k.start)),tricks[k.trick]&&tricks[k.trick](i,Math.max(0,Math.min(1,w)));m-=o.actorDelay}for(c in actors)i=actors[c],i&&i.node&&i._tMatrix&&i.node.setAttribute("transform","matrix("+i._tMatrix.join()+")");_reqAnimFrame(fnTick)};_reqAnimFrame(fnTick);})()]]></script>
               </svg>
            </div>
         </div>
      </div>
      <button class="w3-button w3-black w3-xlarge w3-left" style="height: 10%;"  onclick="openLeftMenu()"><i class="fa fa-users"> </i> </button>
      <button class="w3-button w3-black w3-xlarge w3-right" style="height: 10%;" onclick="openRightMenu()"><i class="fa fa-plus"> </i></button>
      <div id="ContentID">

      </div>

      <input class="textarea" id="statusSent" type="text" placeholder="Got something to share? Tell everyone!"/>
      <div class="w3-sidebar w3-bar-block w3-black w3-xxlarge" style="width:70px; position: fixed; right:0px; bottom: 0%; height: 8.8%; z-index: 2;">

         <button onclick="sendStatusUpdate()" class="w3-bar-item w3-button"> <i class="fa fa-arrow-circle-o-right "></i></button>
      </div>
      <div class="w3-sidebar w3-bar-block w3-black w3-xxlarge" style="width:70px; position: fixed; left:0px; bottom: 0%; height: 8.8%;">
         <a href="settings.html" class="w3-bar-item w3-button"><i class="fa fa-cog"></i></a>
      </div>
      <script>
      mainPageStart()

      function mainPageStart(){
        file = ""
        if (isReleaseBuild() == 0){
         file ="torchat/buddy-list.txt";
       }
       if (isReleaseBuild() == 1){
         file ="torchat/dist/torchat/buddy-list.txt";
       }

         const readline = require('readline');
         const fs = require('fs');

         const rl = readline.createInterface({
           input: fs.createReadStream(file)
         });
         var chat = document.getElementById("leftMenu")
         rl.on('line', (line) => {
           console.log(`Line from file: ${line}`);
           chat.innerHTML += '<div onclick="localStorage.friendChat = &quot;' + line + '&quot;;" > <a href="chat.html" class="w3-bar-item w3-button"> <img class="img-circle" src="http://www.imran.com/xyper_images/icon-user-default.png"> ' + line.split(" ")[1] + '</a> </div>'
         });
        BFC();
       }

 function sendStatusUpdate() {

   var statusText = document.getElementById("statusSent").value;
   document.getElementById("statusSent").value = ""
   //get your entire friends list
   const fs = require('fs');
   var friendslist = fs.readFileSync('torchat/buddy-list.txt', 'utf8')
   for (var i = 0; i < friendslist.split('\n').length - 1; i++){
     console.log(friendslist.split('\n')[i].split(' ')[0] + " " + statusText)
     const fs = require('fs');
     fs.appendFile("sendBuffer.txt", localStorage.friendChat.split(' ')[0] + ":status#" + statusText + "\n", function(err) {
     if(err) {
       return console.log(err);
     }
       });
   }
 }


 const watch = require('node-watch')
 watch('status.txt', function(event, filename) {
   const fs = require('fs');
   var data = fs.readFileSync('status.txt', 'utf8')
   data = data.split(' ')
   document.getElementById("BUMPStatus").innerHTML = "";
   for (var i = 0; i < data.length; i++){
   document.getElementById("BUMPStatus").innerHTML += data[i] + "<br></br>" ;
 }
 })

checkTorChatStatus();

if (isReleaseBuild() == 0){
watch('torchat/torchatready.txt', function(event, filename) { checkTorChatStatus(); })
watch('torchat/statusUpdates.txt', function(event, filename) { document.getElementById("ContentID").innerHTML = ""; StatusUpdate(); })

}
if (isReleaseBuild() == 1){
  watch('torchat/dist/torchat/torchatready.txt', function(event, filename) { checkTorChatStatus(); })
  watch('torchat/dist/torchat/statusUpdates.txt', function(event, filename) { document.getElementById("ContentID").innerHTML = ""; StatusUpdate(); })

}

if (isReleaseBuild() == 0){
watch('torchat/buddy-list.txt', function(event, filename) {
mainPageStart();
})
}
if (isReleaseBuild() == 1){
  watch('torchat/dist/torchat/buddy-list.txt', function(event, filename) {
  mainPageStart();
  })
}

 function checkTorChatStatus() {
   const fs = require('fs');
   if (isReleaseBuild() == 0){
   var data = fs.readFileSync('torchat/torchatready.txt', 'utf8')
 }
 if (isReleaseBuild() == 1){
   var data = fs.readFileSync('torchat/dist/torchat/torchatready.txt', 'utf8')
}

   if (data == 'Ready'){
      document.getElementById("Status").style.backgroundColor = "#77dd77";
      document.getElementById("Status").innerHTML = 'MOXIE is online';
   } else {
     document.getElementById("Status").style.backgroundColor = "#dd7777";
     document.getElementById("Status").innerHTML = 'MOXIE is not online. We are getting ready...';
   }
 }

         function openLeftMenu() {
           document.getElementById("leftMenu").style.display = "block";
         }

         function closeLeftMenu() {
           document.getElementById("leftMenu").style.display = "none";
         }

         function openRightMenu() {
           const fs = require('fs');
           document.getElementById("rightMenu").style.display = "block";
           var data = "TRUE"
           fs.writeFile('statusMainScreen.txt',data,
               function(err) {
                   if (err) throw err;
                   console.log("Data is written to file successfully.")
           });
         }

         function closeRightMenu() {
           const fs = require('fs');
           document.getElementById("rightMenu").style.display = "none";
           var data = "FALSE"
           fs.writeFile('statusMainScreen.txt',data,
               function(err) {
                   if (err) throw err;
                   console.log("Data is written to file successfully.")
                   });
         }



StatusUpdate();

         function StatusUpdate(){
            if (isReleaseBuild() == 0){
           const fs = require('fs');
           var data = fs.readFileSync('torchat/statusUpdates.txt', 'utf8')
           for (var i = 0; i < data.split('\n').length -1; i++){
           var content = document.getElementById("ContentID")
           content.innerHTML += "<h2>" + data.split('\n')[i].split('#')[0] + "</h2>" + "<h4>" + data.split('\n')[i].split('#')[1] + "</h4>"
         }
            }

            if (isReleaseBuild() == 1){
           const fs = require('fs');
           var data = fs.readFileSync('torchat/dist/torchat/statusUpdates.txt', 'utf8')
           for (var i = 0; i < data.split('\n').length -1; i++){
           var content = document.getElementById("ContentID")
           content.innerHTML += "<h2>" + data.split('\n')[i].split('#')[0] + "</h2>" + "<h4>" + data.split('\n')[i].split('#')[1] + "</h4>"
         }
            }

         }

        function BFC(){

         if (isReleaseBuild() == 0){
           const ps = require('python-shell');
           console.log('Starting bump');
        //   ps.PythonShell.run('bump.py', null, function (message) {
          // console.log(message);
        //   });
         }
         if (isReleaseBuild() == 1){
         var exec = require('child_process').execFile;
         var startBump =function(){
           exec('dist/bump/bump', function(err, data) {
             console.log(err)
           });
         }
         startBump();
       }

       }

       function isReleaseBuild(){
         var fs = require('fs');
         var isRelease = 0
         try {
           data = fs.readFileSync('MoxieFlags.config', 'utf8');
           if(data.indexOf('1') > -1) {
             isRelease = 1;
           }
         } catch(e) {
           console.log('Error:', e.stack);
         }
         return isRelease
       }

      </script>
   </body>
</html>

<html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="css/mainscreen.css">
<script src="js/utilities.js" type="text/javascript"> </script>

<body>
  <div class="w3-sidebar w3-bar-block w3-black w3-card w3-animate-left" style="display:none; width:20%;  height: 100%; left: -1%;" id="leftMenu">
    <button onclick="closeLeftMenu()" class="w3-bar-item w3-button w3-large">Close &times;</button>
  </div>

  <div class="StatusLog" id="Status">
    <p> Not Ready </p>
  </div>

  <div class="w3-sidebar w3-bar-block w3-black w3-card w3-animate-right" style="display:none; width:100%;  height: 100%; border-radius: 100%; left:50%; top:0%;" id="rightMenu">
    <button onclick="closeRightMenu()" class="w3-bar-item w3-button w3-large">Close &times;</button>
    <div>
      <div class="TextLog">
        <h2 class="Sus" id="BUMPStatus"> Ready! </h2>
      </div>
      <div class="bumpAnimation">
      </div>
    </div>
  </div>

  <div id="ContentID">

  </div>

  <button onclick='toggleVisibility("Toolkit")' class="round-button-circle"> M </button>
  <div class="Toolkit" id="Toolkit">
    <button class="tool-button-circle"> </button>
    <button class="toolicon-button-circle" onclick="openLeftMenu()"> <i class="fa fa-users"> </i> </button>
    <button class="toolicon1-button-circle" onclick="window.location.href = 'settings.html'"> <i class="fa fa-cog"></i> </button>
    <button class="toolicon2-button-circle" onclick='toggleVisibility("StatusText")'> <i class="fa fa-comment-o"></i> </button>
    <button class="toolicon3-button-circle" onclick="openRightMenu()"> <i class="fa fa-plus"></i> </button>

  </div>

  <div class='status' id="StatusText">
    <input class="textarea" id="statusSent" type="text" placeholder="Got something to share? Tell everyone!" />
    <button class="postStatusButton" onclick="sendStatusUpdate()"> + </button>
  </div>

  </div>
  </div>
  <script>
    mainPageStart()


    function mainPageStart() {
      file = ""
      if (isReleaseBuild() == 0) {
        file = "torchat/buddy-list.txt";
      }
      if (isReleaseBuild() == 1) {
        file = "torchat/dist/torchat/buddy-list.txt";
      }
      if (isReleaseBuild() == 2) {
        file = "torchat/dist/buddy-list.txt";
      }

      const readline = require('readline');
      const fs = require('fs');

      const rl = readline.createInterface({
        input: fs.createReadStream(file)
      });
      var chat = document.getElementById("leftMenu")
      rl.on('line', (line) => {
        console.log(`Line from file: ${line}`);
        chat.innerHTML += '<div onclick="localStorage.friendChat = &quot;' + line + '&quot;;" > <a href="chat.html" class="w3-bar-item w3-button"> <img class="img-circle" src="http://www.imran.com/xyper_images/icon-user-default.png"> ' + line
          .split(" ")[1] + '</a> </div>'
      });
      BFC();
    }

    function sendStatusUpdate() {

      var statusText = document.getElementById("statusSent").value;
      document.getElementById("statusSent").value = ""
      //get your entire friends list
      const fs = require('fs');

      if (isReleaseBuild() == 0) {
        var friendslist = fs.readFileSync('torchat/buddy-list.txt', 'utf8')
      }

      if (isReleaseBuild() == 1) {
        var friendslist = fs.readFileSync('torchat/dist/torchat/buddy-list.txt', 'utf8')
      }

      if (isReleaseBuild() == 2) {
        var friendslist = fs.readFileSync('torchat/dist/buddy-list.txt', 'utf8')
      }


      for (var i = 0; i < friendslist.split('\n').length - 1; i++) {
        console.log(friendslist.split('\n')[i].split(' ')[0] + " " + statusText)
        const fs = require('fs');
        if (isReleaseBuild() == 0) {
          fs.appendFile("sendBuffer.txt", friendslist.split('\n')[i].split(' ')[i] + ":status#" + statusText + "\n", function(err) {
            if (err) {
              return console.log(err);
            }
          });
        }

        if (isReleaseBuild() == 1) {
          fs.appendFile("torchat/dist/sendBuffer.txt", friendslist.split('\n')[i].split(' ')[i] + ":status#" + statusText + "\n", function(err) {
            if (err) {
              return console.log(err);
            }
          });
        }

        if (isReleaseBuild() == 2) {
          fs.appendFile("torchat/sendBuffer.txt", friendslist.split('\n')[i].split(' ')[i] + ":status#" + statusText + "\n", function(err) {
            if (err) {
              return console.log(err);
            }
          });
        }

      }
    }


    const watch = require('node-watch')
    watch('status.txt', function(event, filename) {
      const fs = require('fs');
      var data = fs.readFileSync('status.txt', 'utf8')
      data = data.split(' ')
      document.getElementById("BUMPStatus").innerHTML = "";
      for (var i = 0; i < data.length; i++) {
        document.getElementById("BUMPStatus").innerHTML += data[i] + "<br></br>";
      }
    })

    checkTorChatStatus();

    if (isReleaseBuild() == 0) {
      watch('torchat/torchatready.txt', function(event, filename) {
        checkTorChatStatus();
      })
      watch('torchat/statusUpdates.txt', function(event, filename) {
        document.getElementById("ContentID").innerHTML = "";
        StatusUpdate();
      })

    }
    if (isReleaseBuild() == 1) {
      watch('torchat/dist/torchat/torchatready.txt', function(event, filename) {
        checkTorChatStatus();
      })
      watch('torchat/dist/torchat/statusUpdates.txt', function(event, filename) {
        document.getElementById("ContentID").innerHTML = "";
        StatusUpdate();
      })
    }

    if (isReleaseBuild() == 2) {
      watch('torchat/dist/torchatready.txt', function(event, filename) {
        checkTorChatStatus();
      })
      
      watch('torchat/dist/statusUpdates.txt', function(event, filename) {
        document.getElementById("ContentID").innerHTML = "";
        StatusUpdate();
      })
    }

    if (isReleaseBuild() == 0) {
      watch('torchat/buddy-list.txt', function(event, filename) {
        mainPageStart();
      })
    }

    if (isReleaseBuild() == 1) {
      watch('torchat/dist/torchat/buddy-list.txt', function(event, filename) {
        mainPageStart();
      })
    }

    if (isReleaseBuild() == 2) {
      watch('torchat/dist/torchatready.txt', function(event, filename) {
        checkTorChatStatus();
      })
      watch('torchat/dist/statusUpdates.txt', function(event, filename) {
        document.getElementById("ContentID").innerHTML = "";
        StatusUpdate();
      })
    }

    function checkTorChatStatus() {
      const fs = require('fs');
      if (isReleaseBuild() == 0) {
        var data = fs.readFileSync('torchat/torchatready.txt', 'utf8')
      }
      if (isReleaseBuild() == 1) {
        var data = fs.readFileSync('torchat/dist/torchat/torchatready.txt', 'utf8')
      }

      if (isReleaseBuild() == 2) {
        var data = fs.readFileSync('torchat/dist/torchatready.txt', 'utf8')
      }


      if (data == 'Ready') {
        document.getElementById("Status").style.backgroundColor = "#77dd77";
        document.getElementById("Status").innerHTML = 'MOXIE is online';
      } else {
        document.getElementById("Status").style.backgroundColor = "#dd7777";
        document.getElementById("Status").innerHTML = 'MOXIE is not online. We are getting ready...';
      }
    }

    function openLeftMenu() {
      document.getElementById("leftMenu").style.display = "block";
    }

    function closeLeftMenu() {
      document.getElementById("leftMenu").style.display = "none";
    }

    function openRightMenu() {
      const fs = require('fs');
      document.getElementById("rightMenu").style.display = "block";
      var data = "TRUE"
      fs.writeFile('statusMainScreen.txt', data,
        function(err) {
          if (err) throw err;
          console.log("Data is written to file successfully.")
        });
    }

    function closeRightMenu() {
      const fs = require('fs');
      document.getElementById("rightMenu").style.display = "none";
      var data = "FALSE"
      fs.writeFile('statusMainScreen.txt', data,
        function(err) {
          if (err) throw err;
          console.log("Data is written to file successfully.")
        });
    }



    StatusUpdate();

    function StatusUpdate() {
      if (isReleaseBuild() == 0) {
        const fs = require('fs');
        var data = fs.readFileSync('torchat/statusUpdates.txt', 'utf8')
        for (var i = 0; i < data.split('\n').length - 1; i++) {
          var content = document.getElementById("ContentID")
          content.innerHTML += "<h2>" + data.split('\n')[i].split('#')[0] + "</h2>" + "<h4>" + data.split('\n')[i].split('#')[1] + "</h4>"
        }
      }

      if (isReleaseBuild() == 1) {
        const fs = require('fs');
        var data = fs.readFileSync('torchat/dist/torchat/statusUpdates.txt', 'utf8')
        for (var i = 0; i < data.split('\n').length - 1; i++) {
          var content = document.getElementById("ContentID")
          content.innerHTML += "<h2>" + data.split('\n')[i].split('#')[0] + "</h2>" + "<h4>" + data.split('\n')[i].split('#')[1] + "</h4>"
        }
      }

      if (isReleaseBuild() == 2) {
        const fs = require('fs');
        var data = fs.readFileSync('torchat/dist/statusUpdates.txt', 'utf8')
        for (var i = 0; i < data.split('\n').length - 1; i++) {
          var content = document.getElementById("ContentID")
          content.innerHTML += "<h2>" + data.split('\n')[i].split('#')[0] + "</h2>" + "<h4>" + data.split('\n')[i].split('#')[1] + "</h4>"
        }
      }

    }

    function BFC() {

      if (isReleaseBuild() == 0) {
        const ps = require('python-shell');
        console.log('Starting bump');
        //   ps.PythonShell.run('bump.py', null, function (message) {
        // console.log(message);
        //   });
      }

      if (isReleaseBuild() == 1) {
        var exec = require('child_process').execFile;
        var startBump = function() {
          exec('dist/bump/bump', function(err, data) {
            console.log(err)
          });
        }
        startBump();
      }

      if (isReleaseBuild() == 2) {
        var exec = require('child_process').execFile;
        var startBump = function() {
          exec('dist/bump.exe', function(err, data) {
            console.log(err)
          });
        }
        startBump();
      }

    }
  </script>
</body>

</html>
